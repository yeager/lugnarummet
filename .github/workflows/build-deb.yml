name: Build .deb
on:
  release:
    types: [published]
  workflow_dispatch:
jobs:
  build-deb:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build .deb
        run: |
          set -e
          PKG="lugnarummet"
          VER=$(python3 -c "exec(open('lugnarummet/__init__.py').read()); print(__version__)")
          echo "Building ${PKG} ${VER}"
          sudo apt-get install -y gettext
          ROOT="pkg-deb/${PKG}"
          mkdir -p ${ROOT}/usr/lib/python3/dist-packages/${PKG}
          mkdir -p ${ROOT}/usr/bin ${ROOT}/usr/share/locale
          mkdir -p ${ROOT}/usr/share/applications ${ROOT}/usr/share/icons/hicolor/scalable/apps
          mkdir -p ${ROOT}/DEBIAN
          cp -r ${PKG}/* ${ROOT}/usr/lib/python3/dist-packages/${PKG}/
          printf '#!/usr/bin/python3\nimport sys\nfrom lugnarummet.main import main\nsys.exit(main())\n' > ${ROOT}/usr/bin/${PKG}
          chmod 755 ${ROOT}/usr/bin/${PKG}
          cp data/*.desktop ${ROOT}/usr/share/applications/
          cp data/icons/*.svg ${ROOT}/usr/share/icons/hicolor/scalable/apps/
          for po in po/*.po; do
            [ -f "$po" ] || continue
            lang=$(basename "$po" .po)
            [ "$lang" = "README" ] && continue
            mkdir -p ${ROOT}/usr/share/locale/${lang}/LC_MESSAGES
            msgfmt -o ${ROOT}/usr/share/locale/${lang}/LC_MESSAGES/${PKG}.mo "$po"
          done
          printf 'Package: %s\nVersion: %s-1\nArchitecture: all\nMaintainer: Daniel Nylander <daniel@danielnylander.se>\nDepends: python3 (>= 3.10), python3-gi, gir1.2-gtk-4.0, gir1.2-adw-1\nSection: utils\nPriority: optional\nHomepage: https://github.com/yeager/lugnarummet\nDescription: Sensory regulation and calming strategies\n' "${PKG}" "${VER}" > ${ROOT}/DEBIAN/control
          dpkg-deb --build --root-owner-group ${ROOT}
          mv pkg-deb/*.deb .
      - name: Upload .deb to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VER=$(python3 -c "exec(open('lugnarummet/__init__.py').read()); print(__version__)")
          gh release upload "v${VER}" "lugnarummet_${VER}-1_all.deb" --clobber 2>/dev/null || true
      - uses: actions/upload-artifact@v4
        with:
          name: deb-package
          path: "*.deb"
